version: '3.8'

services:
  # Backend API Service
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORT:-8000}:8000"
    env_file:
      - .env
    environment:
      # Production settings - all from .env (NO DEFAULTS)
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_SALT=${ENCRYPTION_SALT}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - DATABASE_URL=${DATABASE_URL}
      # Query execution limits
      - MAX_QUERY_TIMEOUT=${MAX_QUERY_TIMEOUT:-30}
      - MAX_RESULT_ROWS=${MAX_RESULT_ROWS:-10000}
      - CONNECTION_POOL_SIZE=${CONNECTION_POOL_SIZE:-5}
      - CONNECTION_POOL_MAX_OVERFLOW=${CONNECTION_POOL_MAX_OVERFLOW:-10}
    volumes:
      - vizly-data:/app/data
      - ./backend/logs:/app/logs
      - ./backend/staticfiles:/app/staticfiles
      - ./backend/media:/app/media
    command: sh -c "python manage.py collectstatic --noinput && python manage.py migrate && gunicorn vizly.wsgi:application --bind 0.0.0.0:8000 --workers 4 --timeout 300 --access-logfile - --error-logfile -"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - vizly-network

  # Frontend Service (Production Build)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    ports:
      - "${VITE_PORT:-80}:80"
    env_file:
      - .env
    environment:
      - VITE_API_URL=${VITE_API_URL}
      - VITE_BACKEND_URL=${VITE_BACKEND_URL}
      - VITE_APP_NAME=${VITE_APP_NAME:-Vizly}
      - VITE_APP_VERSION=${VITE_APP_VERSION:-1.0.0}
      - VITE_ENV=production
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - vizly-network

  # Optional: PostgreSQL for internal database
  # Uncomment if you want to use Docker PostgreSQL instead of external DB
  # postgres:
  #   image: postgres:15-alpine
  #   env_file:
  #     - .env
  #   environment:
  #     - POSTGRES_USER=${POSTGRES_USER:-vizly}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
  #     - POSTGRES_DB=${POSTGRES_DB:-vizly}
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-vizly}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - vizly-network

  # Optional: Redis for caching and Celery
  # redis:
  #   image: redis:7-alpine
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis-data:/data
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 3s
  #     retries: 3
  #   networks:
  #     - vizly-network

  # Optional: Celery Worker for scheduled queries
  # celery-worker:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   env_file:
  #     - .env
  #   command: celery -A vizly worker -l info
  #   depends_on:
  #     - backend
  #     - redis
  #   restart: unless-stopped
  #   networks:
  #     - vizly-network

  # Optional: Celery Beat for scheduling
  # celery-beat:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   env_file:
  #     - .env
  #   command: celery -A vizly beat -l info
  #   depends_on:
  #     - backend
  #     - redis
  #   restart: unless-stopped
  #   networks:
  #     - vizly-network

volumes:
  vizly-data:
  # postgres-data:
  # redis-data:

networks:
  vizly-network:
    driver: bridge
